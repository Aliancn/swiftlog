version: '3.8'

services:
  # ============================================================================
  # Infrastructure Services
  # ============================================================================

  postgres:
    image: postgres:16-alpine
    container_name: swiftlog_postgres
    environment:
      POSTGRES_DB: swiftlog
      POSTGRES_USER: swiftlog
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
    # Port not exposed - only accessible within Docker network
    # For local development access, uncomment the line below:
    # ports:
    #   - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backend/migrations:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U swiftlog"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - swiftlog

  loki:
    image: grafana/loki:2.9.0
    container_name: swiftlog_loki
    # Port not exposed - only accessible within Docker network
    # For local development access, uncomment the line below:
    # ports:
    #   - "3100:3100"
    command: -config.file=/etc/loki/config.yaml
    volumes:
      - loki_data:/loki
      - ./loki-config.yaml:/etc/loki/config.yaml:ro
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3100/ready || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - swiftlog

  redis:
    image: redis:7-alpine
    container_name: swiftlog_redis
    # Port not exposed - only accessible within Docker network
    # For local development access, uncomment the line below:
    # ports:
    #   - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - swiftlog

  # ============================================================================
  # Backend Services
  # ============================================================================

  ingestor:
    build:
      context: ./backend
      dockerfile: Dockerfile.ingestor
    container_name: swiftlog_ingestor
    ports:
      - "50051:50051"
    environment:
      DATABASE_URL: postgres://swiftlog:${POSTGRES_PASSWORD:-changeme}@postgres:5432/swiftlog?sslmode=disable
      LOKI_URL: http://loki:3100
      GRPC_PORT: 50051
      LOG_LEVEL: ${LOG_LEVEL:-info}
    depends_on:
      postgres:
        condition: service_healthy
      loki:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - swiftlog

  api:
    build:
      context: ./backend
      dockerfile: Dockerfile.api
    container_name: swiftlog_api
    ports:
      - "8080:8080"
    environment:
      DATABASE_URL: postgres://swiftlog:${POSTGRES_PASSWORD:-changeme}@postgres:5432/swiftlog?sslmode=disable
      LOKI_URL: http://loki:3100
      API_PORT: 8080
      JWT_SECRET: ${JWT_SECRET:-dev-secret-key-change-in-production}
      ENVIRONMENT: ${ENVIRONMENT:-production}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      ADMIN_USERNAME: ${ADMIN_USERNAME:-admin}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD:-admin123}
    depends_on:
      postgres:
        condition: service_healthy
      loki:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - swiftlog

  websocket:
    build:
      context: ./backend
      dockerfile: Dockerfile.websocket
    container_name: swiftlog_websocket
    ports:
      - "8081:8081"
    environment:
      DATABASE_URL: postgres://swiftlog:${POSTGRES_PASSWORD:-changeme}@postgres:5432/swiftlog?sslmode=disable
      WS_PORT: 8081
      REDIS_URL: redis://redis:6379
      ENVIRONMENT: ${ENVIRONMENT:-production}
      LOG_LEVEL: ${LOG_LEVEL:-info}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - swiftlog

  ai-worker:
    build:
      context: ./backend
      dockerfile: Dockerfile.ai-worker
    container_name: swiftlog_ai_worker
    environment:
      DATABASE_URL: postgres://swiftlog:${POSTGRES_PASSWORD:-changeme}@postgres:5432/swiftlog?sslmode=disable
      LOKI_URL: http://loki:3100
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      OPENAI_BASE_URL: ${OPENAI_BASE_URL:-https://api.openai.com/v1}
      OPENAI_MODEL: ${OPENAI_MODEL:-gpt-4o-mini}
      REDIS_URL: redis://redis:6379
      LOG_LEVEL: ${LOG_LEVEL:-info}
    depends_on:
      postgres:
        condition: service_healthy
      loki:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - swiftlog

  # ============================================================================
  # Frontend Service
  # ============================================================================

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_URL: http://localhost:8080/api/v1
        NEXT_PUBLIC_WS_URL: ws://localhost:8081
    container_name: swiftlog_frontend
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: production
    depends_on:
      - api
      - websocket
    restart: unless-stopped
    networks:
      - swiftlog

# ============================================================================
# Networks & Volumes
# ============================================================================

networks:
  swiftlog:
    driver: bridge

volumes:
  postgres_data:
    driver: local
  loki_data:
    driver: local
  redis_data:
    driver: local
